on: [push, pull_request]

jobs:
  builds:
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - { name: "Windows", os: "windows-2019", generator: "Visual Studio 16 2019" }
    name: ${{ matrix.config.name }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v3
        with:
          python-version: "3.9"
      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1
        if: matrix.config.name == 'Windows'
      - name: Install Conan
        run: |
          pip install conan cmake
          conan user
          conan --version
          cmake --version
      - name: Build
        # conan install . --build outdated # before echo "CMake configuration"
        run: |
          conan config set general.revisions_enabled=True
          conan remote add bincrafters https://bincrafters.jfrog.io/artifactory/api/conan/public-conan
          echo "CMake configuration"
          cmake -DCMAKE_BUILD_TYPE="Release" -G "${{ matrix.config.generator }}" -A "x64" .
          echo "CMake install"
          cmake --build . --target install
          cpack
          echo "::set-env name=ARTIFACT_FILE::$(ls sauerbraten*.zip)"
        shell: bash
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.ARTIFACT_FILE }}
          path: ${{ env.ARTIFACT_FILE }}
